######################################

# This script defines the project pipeline - it specifies the execution orders for all the code in this
# repo using a series of actions.

######################################


version: '3.0'

expectations:
  population_size: 100000

actions:

# Generate study population and extract baseline characteristics at Sep 3, 2022
  generate_study_pop_baseline:
    run: cohortextractor:latest generate_cohort
      --study-definition study_definition_baseline
      --output-dir=feather 
      --output-format=feather
    outputs:
      highly_sensitive:
        cohort: output/input_baseline.feather
      
# Data cleaning, defining exclusions, saving final study pop
  data_process_baseline:
    run: r:latest analysis/processing/data_process_baseline.R
    needs: [generate_study_pop_baseline]
    outputs:
      highly_sensitive:
        cohort: output/cohort/cohort_*.csv
      moderately_sensitive:
        descriptive: output/descriptive/total_*.csv

 # Extract outcomes pre-campaign (index date = Sep 3)
  outcomes_sep:
    run: cohortextractor:latest generate_cohort
      --study-definition study_definition_outcomes_1
      --index-date-range "2022-09-03" 
      --output-dir=feather 
      --output-format=feather
    needs: [data_process_baseline]
    outputs:
      highly_sensitive:
        cohort: output/index/input_*.feather

 # Extract outcomes mid-campaign (index date = Oct 15)
  outcomes_oct:
    run: cohortextractor:latest generate_cohort
      --study-definition study_definition_outcomes_1
      --index-date-range "2022-10-15" 
      --output-dir=feather 
      --output-format=feather
    needs: [data_process_baseline]
    outputs:
      highly_sensitive:
        cohort: output/index/input*.feather

 # Extract outcomes during-campaign (index date = Nov 26)
  outcomes_nov:
    run: cohortextractor:latest generate_cohort
      --study-definition study_definition_outcomes_2
      --index-date-range "2022-11-26 to 2023-01-31 by week" 
      --output-dir=feather 
      --output-format=feather
    needs: [data_process_baseline]
    outputs:
      highly_sensitive:
        cohort: output/index/inpu*.feather

# Data cleaning of outcome data (control periods)
  data_process_outcomes_1:
    run: r:latest analysis/processing/data_process_outcomes_1.R
    needs: [outcomes_sep, outcomes_oct]
    outputs:
      highly_sensitive:
        outcomes: output/cohort/outcomes*.csv

# Data cleaning of outcome data (Nov onward)
  data_process_outcomes_2:
    run: r:latest analysis/processing/data_process_outcomes_2.R
    needs: [outcomes_nov]
    outputs:
      highly_sensitive:
        outcomes: output/cohort/outcome*.csv

# Plots of COVID booster uptake by age
  booster_uptake:
   run: r:latest analysis/descriptive/cumulative_vax_byage.R
   needs: [data_process_baseline]
   outputs:
      moderately_sensitive:
        rates_csv: output/cumulative_rates/final_*.csv 
        plot: output/cumulative_rates/plot_*.png


# Aggregate data by age
  aggregate_outcomes_byage:
    run: r:latest analysis/processing/aggregate_outcomes.R
    needs: [data_process_outcomes_1, data_process_outcomes_2]
    outputs:
      moderately_sensitive:
        outcomes: output/covid_outcomes/by_start_date/outcomes_*.csv
        no_patients: output/descriptive/total_n_by_date.csv

# Outcome plots #
  plot_outcomes:
   run: r:latest analysis/descriptive/plot_outcomes_byage.R
   needs: [aggregate_outcomes_byage]
   outputs:
      moderately_sensitive:
        plot: output/covid_outcomes/figures/plot_*.png

# Outcome plots #
  # resp_outcomes:
  #  run: r:latest analysis/descriptive/plot_outcomes_resp_byage.R
  #  needs: [data_process_outcomes]
  #  outputs:
  #     moderately_sensitive:
  #       measure_csv: output/covid_outcomes/plot*.csv
  #       plot: output/covid_outcomes/plot*.png

# Discontinuity of demographics
  # demographics:
  #  run: r:latest analysis/descriptive/demographics_byage.R
  #  needs: [generate_study_pop_baseline, data_process_baseline]
  #  outputs:
  #     moderately_sensitive:
  #       measures_csv: output/descriptive/demographics_*.csv


# Flu vaccine uptake #
  # flu_vax:
  #  run: r:latest analysis/descriptive/flu_vax_byage.R
  #  needs: [generate_study_pop]
  #  outputs:
  #     moderately_sensitive:
  #       measure_csv: output/cumulative_rates/flu_*.csv
  #       plot: output/cumulative_rates/plot_flu_vax_byage.png

# ITT analysis #
  # itt_analysis:
  #  run: r:latest analysis/statistical_analysis/itt_analysis.R
  #  needs: [data_process_outcomes]
  #  outputs:
  #     moderately_sensitive:
  #       measure_csv: output/covid_outcomes/outcome_*.csv

# Outcome plots #
  # covid_outcomes:
  #  run: r:latest analysis/descriptive/covid_outcomes_byage.R
  #  needs: [generate_study_pop]
  #  outputs:
  #     moderately_sensitive:
  #       measure_csv: output/covid_outcomes/covid_*.csv
  #       plot: output/covid_outcomes/plot_outcomes_*.png
  




# IV analysis #



  
