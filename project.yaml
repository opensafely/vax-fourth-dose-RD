######################################

# This script defines the project pipeline - it specifies the execution orders for all the code in this
# repo using a series of actions.

######################################


version: '3.0'

expectations:
  population_size: 10000

actions:

# Generate study population and extract baseline characteristics at Sep 3, 2022
  generate_study_pop_baseline:
    run: cohortextractor:latest generate_cohort
      --study-definition study_definition_baseline
      --output-dir=feather 
      --output-format=feather
    outputs:
      highly_sensitive:
        cohort: output/input_baseline.feather
      
# Data cleaning, defining exclusions, saving final study pop
  data_process_baseline:
    run: r:latest analysis/processing/data_processing_baseline.R
    needs: [generate_study_pop_baseline]
    outputs:
      highly_sensitive:
        cohort: output/cohort/cohort_*.csv
      moderately_sensitive:
        descriptive: output/descriptive/total_*.csv

 # Extract outcomes based on final study pop
  study_definition_outcomes:
    run: cohortextractor:latest generate_cohort
      --study-definition study_definition_outcomes
      --index-date-range "2022-09-03 to 2023-01-31 by week" 
      --output-dir=feather 
      --output-format=feather
    needs: [data_process_baseline]
    outputs:
      highly_sensitive:
        cohort: output/index/input_outcomes_*.feather

# Data cleaning of outcome data
  data_process_index:
    run: r:latest analysis/processing/data_processing_index.R
    needs: [study_definition_outcomes]
    outputs:
      moderately_sensitive:
        descriptive: output/descriptive/num_outcomes*.csv

# Discontinuity of demographics
  demographics:
   run: r:latest analysis/descriptive/demographics_byage.R
   needs: [generate_study_pop_baseline, data_process_baseline]
   outputs:
      moderately_sensitive:
        measures_csv: output/descriptive/demographics_*.csv

# Plots of COVID booster uptake by age
  booster_update:
   run: r:latest analysis/descriptive/cumulative_vax_byage.R
   needs: [data_process_baseline]
   outputs:
      moderately_sensitive:
        rates_csv: output/cumulative_rates/final_*.csv 
        plot: output/cumulative_rates/plot_*.png

# Flu vaccine uptake #
  # flu_vax:
  #  run: r:latest analysis/descriptive/flu_vax_byage.R
  #  needs: [generate_study_pop]
  #  outputs:
  #     moderately_sensitive:
  #       measure_csv: output/cumulative_rates/flu_*.csv
  #       plot: output/cumulative_rates/plot_flu_vax_byage.png


# Outcome plots #
  # covid_outcomes:
  #  run: r:latest analysis/descriptive/covid_outcomes_byage.R
  #  needs: [generate_study_pop]
  #  outputs:
  #     moderately_sensitive:
  #       measure_csv: output/covid_outcomes/covid_*.csv
  #       plot: output/covid_outcomes/plot_outcomes_*.png
  

# ITT analysis #


# IV analysis #



  
